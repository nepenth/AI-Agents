# JSON Prompt System Documentation\n\n## Overview\n\nThe JSON Prompt System is a comprehensive replacement for the original `prompts.py` module, providing structured, maintainable, and extensible prompt management for the Knowledge Base Agent. This system converts all prompts from hardcoded Python strings to structured JSON configurations with validation, templating, and runtime management capabilities.\n\n## Architecture\n\n### Core Components\n\n1. **JsonPrompt** (`knowledge_base_agent/json_prompt.py`)\n   - Base class for individual JSON prompt configurations\n   - Handles loading, validation, and rendering of prompts\n   - Supports parameter validation and template rendering\n\n2. **JsonPromptManager** (`knowledge_base_agent/json_prompt_manager.py`)\n   - Runtime management system for JSON prompts\n   - Provides caching, search, validation, and catalog functionality\n   - Handles prompt loading from directory structures\n\n3. **Drop-in Replacement** (`knowledge_base_agent/prompts_replacement.py`)\n   - Maintains identical interfaces to original `LLMPrompts` and `ReasoningPrompts` classes\n   - Provides seamless migration with fallback capabilities\n   - Environment-controlled switching between systems\n\n4. **Migration Tools** (`knowledge_base_agent/migration_tools.py`)\n   - Tools for migrating from original to JSON prompt system\n   - Backup, rollback, and deployment capabilities\n   - Validation and testing utilities\n\n### Directory Structure\n\n```\nknowledge_base_agent/\n├── prompts_json/\n│   ├── config.json              # Configuration file\n│   ├── standard/                # Standard model prompts\n│   │   ├── categorization_standard.json\n│   │   ├── chat_standard.json\n│   │   ├── kb_item_generation_standard.json\n│   │   └── ...\n│   └── reasoning/               # Reasoning model prompts\n│       ├── categorization_reasoning.json\n│       ├── system_message.json\n│       ├── kb_item_generation_reasoning.json\n│       └── ...\n├── json_prompt.py               # JsonPrompt base class\n├── json_prompt_manager.py       # JsonPromptManager\n├── prompts_replacement.py       # Drop-in replacement\n└── migration_tools.py           # Migration utilities\n```\n\n## JSON Prompt Schema\n\n### Schema Structure\n\nAll JSON prompts follow a standardized schema defined in `knowledge_base_agent/prompt_schema.json`:\n\n```json\n{\n  \"prompt_id\": \"unique_identifier\",\n  \"prompt_name\": \"Human Readable Name\",\n  \"description\": \"Description of the prompt's purpose\",\n  \"model_type\": \"standard|reasoning\",\n  \"category\": \"categorization|chat|synthesis|etc\",\n  \"task\": \"Brief description of the task\",\n  \"input_parameters\": {\n    \"required\": [\"param1\", \"param2\"],\n    \"optional\": [\"param3\"],\n    \"parameters\": {\n      \"param1\": {\n        \"type\": \"string|integer|boolean|array|object\",\n        \"description\": \"Parameter description\",\n        \"validation\": {\n          \"min_length\": 1,\n          \"max_length\": 1000,\n          \"enum\": [\"option1\", \"option2\"]\n        },\n        \"default\": \"default_value\"\n      }\n    }\n  },\n  \"template\": {\n    \"type\": \"standard|reasoning\",\n    \"content\": \"Template for standard models\",\n    \"system_message\": \"System message for reasoning models\",\n    \"user_message\": \"User message for reasoning models\"\n  },\n  \"variants\": [\n    {\n      \"name\": \"variant_name\",\n      \"condition\": \"parameter_condition\",\n      \"template\": { /* variant template */ }\n    }\n  ],\n  \"examples\": [\n    {\n      \"name\": \"example_name\",\n      \"input\": { /* example parameters */ },\n      \"expected_output\": \"Expected result\"\n    }\n  ],\n  \"metadata\": {\n    \"version\": \"1.0.0\",\n    \"author\": \"Author Name\",\n    \"tags\": [\"tag1\", \"tag2\"],\n    \"last_updated\": \"2024-01-01T00:00:00Z\"\n  }\n}\n```\n\n### Model Types\n\n#### Standard Model Prompts\n\nStandard model prompts use a simple string template:\n\n```json\n{\n  \"template\": {\n    \"type\": \"standard\",\n    \"content\": \"You are an expert {{role}}. Please {{task}} the following: {{input}}\"\n  }\n}\n```\n\n#### Reasoning Model Prompts\n\nReasoning model prompts use separate system and user messages:\n\n```json\n{\n  \"template\": {\n    \"type\": \"reasoning\",\n    \"system_message\": \"You are an expert {{role}} with step-by-step thinking capabilities.\",\n    \"user_message\": \"Please {{task}} the following: {{input}}\"\n  }\n}\n```\n\n### Parameter Types and Validation\n\n#### String Parameters\n\n```json\n{\n  \"parameter_name\": {\n    \"type\": \"string\",\n    \"description\": \"A text parameter\",\n    \"validation\": {\n      \"min_length\": 1,\n      \"max_length\": 1000,\n      \"pattern\": \"^[a-zA-Z0-9_]+$\",\n      \"enum\": [\"option1\", \"option2\", \"option3\"]\n    },\n    \"default\": \"default_value\"\n  }\n}\n```\n\n#### Integer Parameters\n\n```json\n{\n  \"count\": {\n    \"type\": \"integer\",\n    \"description\": \"A numeric parameter\",\n    \"validation\": {\n      \"minimum\": 1,\n      \"maximum\": 100\n    },\n    \"default\": 10\n  }\n}\n```\n\n#### Boolean Parameters\n\n```json\n{\n  \"is_enabled\": {\n    \"type\": \"boolean\",\n    \"description\": \"A boolean flag\",\n    \"default\": false\n  }\n}\n```\n\n#### Array Parameters\n\n```json\n{\n  \"items\": {\n    \"type\": \"array\",\n    \"description\": \"A list of items\",\n    \"validation\": {\n      \"min_items\": 1,\n      \"max_items\": 10,\n      \"item_type\": \"string\"\n    },\n    \"default\": []\n  }\n}\n```\n\n#### Object Parameters\n\n```json\n{\n  \"config\": {\n    \"type\": \"object\",\n    \"description\": \"A configuration object\",\n    \"validation\": {\n      \"required_keys\": [\"key1\", \"key2\"],\n      \"allowed_keys\": [\"key1\", \"key2\", \"key3\"]\n    },\n    \"default\": {}\n  }\n}\n```\n\n### Template Rendering\n\nTemplates use Jinja2 syntax for parameter substitution:\n\n```json\n{\n  \"template\": {\n    \"type\": \"standard\",\n    \"content\": \"Hello {{name}}! {% if is_formal %}Good day{% else %}Hey there{% endif %}!\"\n  }\n}\n```\n\n### Variants and Conditional Logic\n\nVariants allow different templates based on parameter conditions:\n\n```json\n{\n  \"variants\": [\n    {\n      \"name\": \"formal\",\n      \"condition\": \"is_formal == true\",\n      \"template\": {\n        \"type\": \"standard\",\n        \"content\": \"Good day, {{name}}. How may I assist you?\"\n      }\n    },\n    {\n      \"name\": \"casual\",\n      \"condition\": \"is_formal == false\",\n      \"template\": {\n        \"type\": \"standard\",\n        \"content\": \"Hey {{name}}! What's up?\"\n      }\n    }\n  ]\n}\n```\n\n## Usage Guide\n\n### Basic Usage\n\n#### Using JsonPromptManager\n\n```python\nfrom knowledge_base_agent.json_prompt_manager import JsonPromptManager\n\n# Initialize manager\nmanager = JsonPromptManager()\n\n# Get available prompts\navailable = manager.get_available_prompts()\nprint(f\"Available prompts: {available}\")\n\n# Load and render a prompt\nresult = manager.render_prompt(\n    \"categorization_standard\",\n    {\n        \"context_content\": \"React hooks tutorial\",\n        \"formatted_existing_categories\": \"frontend, react, hooks\",\n        \"is_thread\": False\n    },\n    \"standard\"\n)\n\nprint(f\"Rendered prompt: {result.content}\")\nprint(f\"Render time: {result.render_time_ms}ms\")\n```\n\n#### Using Drop-in Replacement\n\n```python\n# Set environment variable to use JSON prompts\nimport os\nos.environ['USE_JSON_PROMPTS'] = 'true'\n\n# Import replacement classes (identical interface to original)\nfrom knowledge_base_agent.prompts_replacement import LLMPrompts, ReasoningPrompts\n\n# Use exactly like original prompts\nchat_prompt = LLMPrompts.get_chat_prompt()\ncategorization_prompt = LLMPrompts.get_categorization_prompt_standard(\n    \"React hooks tutorial\",\n    \"frontend, react, hooks\",\n    False\n)\n\nsystem_message = ReasoningPrompts.get_system_message()\n```\n\n#### Environment Control\n\n```python\nfrom knowledge_base_agent.prompts_replacement import (\n    use_json_prompts, is_using_json_prompts, get_prompt_system_info\n)\n\n# Enable JSON prompts\nuse_json_prompts(True)\nprint(f\"Using JSON prompts: {is_using_json_prompts()}\")\n\n# Get system information\ninfo = get_prompt_system_info()\nprint(f\"System info: {info}\")\n\n# Disable JSON prompts (fallback to original)\nuse_json_prompts(False)\n```\n\n### Advanced Usage\n\n#### Custom Prompt Loading\n\n```python\nfrom knowledge_base_agent.json_prompt import JsonPrompt\n\n# Load prompt from file\nprompt = JsonPrompt(\"path/to/prompt.json\")\n\n# Load prompt from dictionary\nprompt_data = {\n    \"prompt_id\": \"custom_prompt\",\n    \"prompt_name\": \"Custom Prompt\",\n    # ... rest of prompt definition\n}\nprompt = JsonPrompt(prompt_data)\n\n# Validate parameters\nerrors = prompt.validate_parameters({\"param1\": \"value1\"})\nif errors:\n    print(f\"Validation errors: {errors}\")\n\n# Render with parameters\nresult = prompt.render({\"param1\": \"value1\", \"param2\": \"value2\"})\n```\n\n#### Prompt Search and Discovery\n\n```python\nmanager = JsonPromptManager()\n\n# Search prompts by name or description\nresults = manager.search_prompts(\"categorization\")\nprint(f\"Found {len(results)} prompts\")\n\n# Get prompts by category\nchat_prompts = manager.get_prompts_by_category(\"chat\")\n\n# Get prompt information\ninfo = manager.get_prompt_info(\"chat_standard\", \"standard\")\nprint(f\"Prompt info: {info}\")\n```\n\n#### Validation and Testing\n\n```python\n# Validate a specific prompt\nvalidation_result = manager.validate_prompt(\"chat_standard\", \"standard\")\nif validation_result[\"valid\"]:\n    print(\"Prompt is valid\")\nelse:\n    print(f\"Validation errors: {validation_result['errors']}\")\n\n# Preload prompts for performance\nresults = manager.preload_prompts([\"standard\", \"reasoning\"])\nprint(f\"Preloaded {results['loaded']} prompts\")\n\n# Get cache statistics\nstats = manager.get_cache_stats()\nprint(f\"Cache hit rate: {stats['hit_rate']:.2%}\")\n```\n\n#### Export and Catalog\n\n```python\n# Export prompt catalog\ncatalog = manager.export_prompt_catalog()\nprint(f\"Total prompts: {catalog['total_prompts']}\")\n\n# Export to file\ncatalog = manager.export_prompt_catalog(\"prompt_catalog.json\")\n```\n\n## Migration Guide\n\n### Automatic Migration\n\nThe system provides automatic migration tools:\n\n```python\nfrom knowledge_base_agent.migration_tools import MigrationManager\n\n# Initialize migration manager\nmigration_manager = MigrationManager()\n\n# Check current status\nstatus = migration_manager.get_migration_status()\nprint(f\"Current system: {status['current_system']}\")\n\n# Validate JSON prompts before migration\nvalidation_results = migration_manager.validate_json_prompts()\nif validation_results[\"valid\"]:\n    print(\"JSON prompts are valid, ready for migration\")\nelse:\n    print(f\"Validation errors: {validation_results['errors']}\")\n```\n\n### Step-by-Step Migration\n\n1. **Validate JSON Prompts**\n   ```python\n   results = migration_manager.validate_json_prompts()\n   assert results[\"valid\"], f\"Validation failed: {results['errors']}\"\n   ```\n\n2. **Create Backup**\n   ```python\n   backup_path = migration_manager.create_backup(\"Pre-migration backup\")\n   print(f\"Backup created at: {backup_path}\")\n   ```\n\n3. **Migrate to JSON System**\n   ```python\n   success = migration_manager.migrate_to_json()\n   if success:\n       print(\"Migration completed successfully\")\n   else:\n       print(\"Migration failed\")\n   ```\n\n4. **Test the System**\n   ```python\n   # Test basic functionality\n   from knowledge_base_agent.prompts_replacement import LLMPrompts\n   chat_prompt = LLMPrompts.get_chat_prompt()\n   assert len(chat_prompt) > 0, \"Chat prompt should not be empty\"\n   ```\n\n5. **Rollback if Needed**\n   ```python\n   if something_wrong:\n       success = migration_manager.rollback_to_original()\n       print(f\"Rollback {'successful' if success else 'failed'}\")\n   ```\n\n### Environment Configuration\n\nControl the prompt system using environment variables:\n\n```bash\n# Enable JSON prompts (default)\nexport USE_JSON_PROMPTS=true\n\n# Disable JSON prompts (use original system)\nexport USE_JSON_PROMPTS=false\n```\n\nOr in `.env` file:\n```\nUSE_JSON_PROMPTS=true\n```\n\n## Testing Documentation\n\n### Unit Testing\n\nThe system includes comprehensive unit tests:\n\n```bash\n# Run all tests\npython -m pytest tests/\n\n# Run specific test files\npython -m pytest tests/test_json_prompt.py\npython -m pytest tests/test_json_prompt_manager.py\npython -m pytest tests/test_integration.py\n```\n\n### Test Categories\n\n1. **JsonPrompt Tests** (`tests/test_json_prompt.py`)\n   - Basic functionality (loading, validation, rendering)\n   - Parameter validation\n   - Template rendering\n   - Variant selection\n   - Error handling\n\n2. **JsonPromptManager Tests** (`tests/test_json_prompt_manager.py`)\n   - Prompt loading and caching\n   - Search and discovery\n   - Validation\n   - Performance testing\n\n3. **Integration Tests** (`tests/test_integration.py`)\n   - End-to-end workflow testing\n   - Real prompt file testing\n   - System integration\n\n### Performance Testing\n\n```python\nfrom knowledge_base_agent.test_performance_quality import PerformanceQualityTester\n\n# Run performance tests\ntester = PerformanceQualityTester()\nresults = tester.run_performance_tests()\n\nprint(f\"Average render time: {results['average_render_time_ms']:.2f}ms\")\nprint(f\"Memory usage: {results['memory_usage_mb']:.2f}MB\")\n```\n\n### Comparison Testing\n\n```python\nfrom knowledge_base_agent.test_prompt_comparison import PromptComparisonTester\n\n# Compare JSON prompts with original prompts\ntester = PromptComparisonTester()\nresults = tester.run_comparison_tests()\n\nprint(f\"Similarity score: {results['average_similarity']:.2%}\")\nprint(f\"Tests passed: {results['tests_passed']}/{results['total_tests']}\")\n```\n\n## Best Practices\n\n### Prompt Design\n\n1. **Use Descriptive IDs**: Choose clear, descriptive prompt IDs\n   ```json\n   {\n     \"prompt_id\": \"categorization_standard\",  // Good\n     \"prompt_id\": \"cat_std\",                  // Bad\n   }\n   ```\n\n2. **Comprehensive Descriptions**: Provide detailed descriptions\n   ```json\n   {\n     \"description\": \"Categorizes technical content into specific main and sub-categories with filename-compatible naming\"\n   }\n   ```\n\n3. **Parameter Validation**: Always include parameter validation\n   ```json\n   {\n     \"context_content\": {\n       \"type\": \"string\",\n       \"description\": \"Content to categorize\",\n       \"validation\": {\n         \"min_length\": 10,\n         \"max_length\": 10000\n       }\n     }\n   }\n   ```\n\n4. **Provide Examples**: Include usage examples\n   ```json\n   {\n     \"examples\": [\n       {\n         \"name\": \"react_tutorial\",\n         \"input\": {\n           \"context_content\": \"Advanced React hooks patterns\",\n           \"formatted_existing_categories\": \"frontend, react\",\n           \"is_thread\": false\n         },\n         \"expected_output\": \"Categorized content with main_category, sub_category, and item_name\"\n       }\n     ]\n   }\n   ```\n\n### Performance Optimization\n\n1. **Use Caching**: The JsonPromptManager automatically caches loaded prompts\n2. **Preload Prompts**: For better performance, preload frequently used prompts\n3. **Validate Once**: Validate prompts during deployment, not at runtime\n4. **Monitor Cache**: Check cache hit rates and adjust as needed\n\n### Error Handling\n\n1. **Graceful Fallback**: The drop-in replacement automatically falls back to original prompts on errors\n2. **Comprehensive Logging**: All errors are logged with context\n3. **Validation First**: Always validate prompts before deployment\n4. **Test Thoroughly**: Use the comprehensive test suite\n\n### Maintenance\n\n1. **Version Control**: Track prompt versions in metadata\n2. **Regular Validation**: Periodically validate all prompts\n3. **Performance Monitoring**: Monitor render times and cache performance\n4. **Documentation Updates**: Keep documentation synchronized with changes\n\n## Troubleshooting Guide\n\n### Common Issues\n\n#### 1. Prompt Not Found\n\n**Error**: `JsonPromptManagerError: Prompt file not found: prompt_name (model_type)`\n\n**Solutions**:\n- Check that the prompt file exists in the correct directory\n- Verify the prompt ID matches the filename (without .json extension)\n- Ensure the model_type directory exists (standard/reasoning)\n\n```python\n# Debug: List available prompts\nmanager = JsonPromptManager()\navailable = manager.get_available_prompts()\nprint(f\"Available prompts: {available}\")\n```\n\n#### 2. Parameter Validation Failed\n\n**Error**: `JsonPromptRenderError: Parameter validation failed: Missing required parameter: param_name`\n\n**Solutions**:\n- Check that all required parameters are provided\n- Verify parameter types match the schema\n- Review parameter validation rules\n\n```python\n# Debug: Check parameter requirements\nprompt = manager.load_prompt(\"prompt_id\", \"model_type\")\nprint(f\"Required parameters: {prompt.required_parameters}\")\nprint(f\"Optional parameters: {prompt.optional_parameters}\")\n\n# Validate parameters before rendering\nerrors = prompt.validate_parameters(your_parameters)\nif errors:\n    print(f\"Validation errors: {errors}\")\n```\n\n#### 3. Template Rendering Error\n\n**Error**: `JsonPromptRenderError: Template rendering failed: ...`\n\n**Solutions**:\n- Check Jinja2 template syntax\n- Ensure all template variables have corresponding parameters\n- Verify conditional logic in templates\n\n```python\n# Debug: Check template content\nprompt = manager.load_prompt(\"prompt_id\", \"model_type\")\nprint(f\"Template: {prompt.data['template']}\")\n```\n\n#### 4. JSON Schema Validation Error\n\n**Error**: `JsonPromptValidationError: Schema validation failed: ...`\n\n**Solutions**:\n- Check JSON syntax (commas, brackets, quotes)\n- Verify all required fields are present\n- Ensure field types match the schema\n\n```python\n# Debug: Validate specific prompt\nvalidation_result = manager.validate_prompt(\"prompt_id\", \"model_type\")\nprint(f\"Validation result: {validation_result}\")\n```\n\n#### 5. Import Errors\n\n**Error**: `ImportError: cannot import name 'JsonPromptManager'`\n\n**Solutions**:\n- Check that all required files are present\n- Verify Python path includes the knowledge_base_agent directory\n- Ensure no circular imports\n\n```python\n# Debug: Check module loading\nimport sys\nsys.path.insert(0, '/path/to/your/project')\n\ntry:\n    from knowledge_base_agent.json_prompt_manager import JsonPromptManager\n    print(\"Import successful\")\nexcept ImportError as e:\n    print(f\"Import failed: {e}\")\n```\n\n#### 6. Environment Configuration Issues\n\n**Error**: System not using JSON prompts despite configuration\n\n**Solutions**:\n- Check environment variable: `echo $USE_JSON_PROMPTS`\n- Verify .env file configuration\n- Clear cached managers\n\n```python\n# Debug: Check environment configuration\nfrom knowledge_base_agent.prompts_replacement import get_prompt_system_info\n\ninfo = get_prompt_system_info()\nprint(f\"System info: {info}\")\n\n# Force refresh\nfrom knowledge_base_agent.prompts_replacement import use_json_prompts\nuse_json_prompts(True)  # This clears caches\n```\n\n### Performance Issues\n\n#### Slow Prompt Rendering\n\n**Solutions**:\n- Use prompt caching (enabled by default)\n- Preload frequently used prompts\n- Optimize template complexity\n- Monitor cache hit rates\n\n```python\n# Check cache performance\nstats = manager.get_cache_stats()\nprint(f\"Cache hit rate: {stats['hit_rate']:.2%}\")\nprint(f\"Cached prompts: {stats['cached_prompts']}\")\n\n# Preload prompts\nresults = manager.preload_prompts([\"standard\", \"reasoning\"])\nprint(f\"Preloaded {results['loaded']} prompts\")\n```\n\n#### High Memory Usage\n\n**Solutions**:\n- Clear prompt cache periodically\n- Limit the number of cached prompts\n- Use lazy loading for large prompt sets\n\n```python\n# Clear cache\nmanager.clear_cache()\n\n# Monitor memory usage\nimport psutil\nprocess = psutil.Process()\nprint(f\"Memory usage: {process.memory_info().rss / 1024 / 1024:.2f} MB\")\n```\n\n### Migration Issues\n\n#### Migration Validation Failed\n\n**Solutions**:\n- Fix validation errors in JSON prompts\n- Use `--force` flag to proceed despite errors\n- Check individual prompt files\n\n```python\n# Detailed validation\nfrom knowledge_base_agent.migration_tools import MigrationManager\n\nmigration_manager = MigrationManager()\nresults = migration_manager.validate_json_prompts()\n\nfor error in results.get('errors', []):\n    print(f\"Error: {error}\")\n```\n\n#### Rollback Failed\n\n**Solutions**:\n- Check backup availability\n- Manually restore from backup\n- Reset environment variables\n\n```python\n# Check rollback availability\nstatus = migration_manager.get_migration_status()\nprint(f\"Rollback available: {status['rollback_available']}\")\n\n# List available backups\nbackups = migration_manager.list_backups()\nfor backup in backups:\n    print(f\"Backup: {backup['name']} - {backup['description']}\")\n```\n\n### Getting Help\n\nIf you encounter issues not covered in this guide:\n\n1. **Check Logs**: Look for detailed error messages in application logs\n2. **Run Tests**: Execute the test suite to identify specific problems\n3. **Validate System**: Use the validation tools to check system integrity\n4. **Create Minimal Example**: Isolate the issue with a minimal test case\n\n```python\n# Comprehensive system check\nfrom knowledge_base_agent.migration_tools import MigrationManager, DeploymentManager\n\n# Check migration status\nmigration_manager = MigrationManager()\nstatus = migration_manager.get_migration_status()\nprint(f\"Migration status: {status}\")\n\n# Validate deployment\ndeployment_manager = DeploymentManager()\nresults = deployment_manager.validate_deployment()\nprint(f\"Deployment validation: {results}\")\n\n# Test basic functionality\nfrom knowledge_base_agent.prompts_replacement import LLMPrompts, get_prompt_system_info\ninfo = get_prompt_system_info()\nprint(f\"System info: {info}\")\n\ntry:\n    chat_prompt = LLMPrompts.get_chat_prompt()\n    print(f\"✅ Basic functionality working (prompt length: {len(chat_prompt)})\")\nexcept Exception as e:\n    print(f\"❌ Basic functionality failed: {e}\")\n```\n\n## Conclusion\n\nThe JSON Prompt System provides a robust, maintainable, and extensible replacement for the original prompt management system. With comprehensive validation, testing, and migration tools, it enables safe transition while maintaining full backward compatibility.\n\nKey benefits:\n- **Structured Configuration**: JSON-based prompts with schema validation\n- **Runtime Management**: Caching, search, and performance optimization\n- **Seamless Migration**: Drop-in replacement with automatic fallback\n- **Comprehensive Testing**: Unit tests, integration tests, and comparison testing\n- **Production Ready**: Migration tools, deployment utilities, and monitoring\n\nFor additional support or questions, refer to the troubleshooting guide or run the comprehensive validation tools provided.\n"