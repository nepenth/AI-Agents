<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Frontend Fixes Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        button { margin: 5px; padding: 10px; }
        #log { background: #f5f5f5; padding: 10px; height: 300px; overflow-y: auto; font-family: monospace; }
    </style>
</head>
<body>
    <h1>Frontend Fixes Test</h1>
    
    <div class="test-section">
        <h2>1. SocketIO Loading Test</h2>
        <p>Status: <span id="socketio-status">Testing...</span></p>
        <p>Mode: <span id="api-mode">Unknown</span></p>
        <button onclick="testSocketIO()">Test SocketIO Connection</button>
    </div>
    
    <div class="test-section">
        <h2>2. API Methods Test</h2>
        <p>API Client: <span id="api-status">Not initialized</span></p>
        <button onclick="testAPIClient()">Test API Client</button>
        <button onclick="testPreferencesAPI()">Test Preferences API</button>
    </div>
    
    <div class="test-section">
        <h2>3. Test Log</h2>
        <div id="log"></div>
        <button onclick="clearLog()">Clear Log</button>
    </div>

    <!-- Include the API client -->
    <script>
    // Simple API client for testing
    class API {
        constructor(baseURL = '/api') {
            this.baseURL = baseURL;
        }

        async request(endpoint, { method = 'GET', headers = {}, body = null } = {}) {
            const cfg = { method, headers: { 'Content-Type': 'application/json', ...headers } };
            if (body) cfg.body = typeof body === 'string' ? body : JSON.stringify(body);
            try {
                const res = await fetch(`${this.baseURL}${endpoint}`, cfg);
                if (!res.ok) {
                    const text = await res.text();
                    throw new Error(`HTTP ${res.status} â€“ ${text || res.statusText}`);
                }
                const ct = res.headers.get('content-type') || '';
                return ct.includes('application/json') ? res.json() : res.text();
            } catch (err) {
                console.error('API request error', err);
                throw err;
            }
        }

        // Agent Status Methods
        async getAgentStatus() {
            return this.request('/agent/status');
        }

        async resetAgentState() {
            return this.request('/agent/reset-state', { method: 'POST' });
        }

        // Agent Control Methods
        async startAgent(preferences = {}) {
            return this.request('/v2/agent/start', { 
                method: 'POST', 
                body: { preferences } 
            });
        }

        async stopAgent() {
            return this.request('/agent/stop', { method: 'POST' });
        }

        // Preferences Methods
        async getPreferences() {
            return this.request('/preferences');
        }

        async savePreferences(preferences) {
            return this.request('/preferences', { 
                method: 'POST', 
                body: preferences 
            });
        }

        // Alias for backward compatibility
        async updatePreferences(preferences) {
            return this.savePreferences(preferences);
        }
    }

    // Enhanced SocketIO Loading Test
    (function() {
        'use strict';
        
        log('âœ… [System] Starting enhanced SocketIO initialization...');
        
        // Global state management
        window.SOCKETIO_DISABLED = false;
        window.REST_API_MODE = false;
        window.SOCKETIO_LOADING = true;
        
        function dispatchEvent(eventName, data = {}) {
            const event = new CustomEvent(eventName, { detail: data });
            document.dispatchEvent(event);
        }
        
        function enableRestApiMode(reason) {
            log(`â„¹ï¸ [System] Switching to REST API mode: ${reason}`);
            window.SOCKETIO_DISABLED = true;
            window.REST_API_MODE = true;
            window.SOCKETIO_LOADING = false;
            updateStatus('socketio-status', 'Failed - Using REST API', 'error');
            updateStatus('api-mode', 'REST API Only', 'info');
            dispatchEvent('socketio-failed', { error: reason });
        }
        
        function enableSocketIOMode() {
            log('âœ… [System] SocketIO successfully loaded, enabling hybrid mode');
            window.SOCKETIO_DISABLED = false;
            window.REST_API_MODE = false;
            window.SOCKETIO_LOADING = false;
            updateStatus('socketio-status', 'Connected', 'success');
            updateStatus('api-mode', 'Hybrid (REST + SocketIO)', 'success');
            dispatchEvent('socketio-ready');
        }
        
        // Timeout for SocketIO loading (5 seconds)
        const socketIOTimeout = setTimeout(() => {
            if (window.SOCKETIO_LOADING) {
                enableRestApiMode('SocketIO loading timeout (5s)');
            }
        }, 5000);
        
        // Try to load SocketIO from multiple CDNs
        const socketIOSources = [
            'https://cdn.socket.io/4.7.2/socket.io.min.js',
            'https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js',
            'https://unpkg.com/socket.io-client@4.7.2/dist/socket.io.min.js'
        ];
        
        let currentSourceIndex = 0;
        
        function tryLoadSocketIO() {
            if (currentSourceIndex >= socketIOSources.length) {
                clearTimeout(socketIOTimeout);
                enableRestApiMode('All SocketIO CDN sources failed');
                return;
            }
            
            const script = document.createElement('script');
            const source = socketIOSources[currentSourceIndex];
            
            log(`ðŸ”„ [System] Attempting to load SocketIO from: ${source}`);
            
            script.onload = function() {
                clearTimeout(socketIOTimeout);
                log(`âœ… [System] SocketIO loaded successfully from: ${source}`);
                
                // Initialize SocketIO connection
                try {
                    window.socket = io({
                        transports: ['websocket', 'polling'],
                        timeout: 10000,
                        reconnection: true,
                        reconnectionAttempts: 3,
                        reconnectionDelay: 1000
                    });
                    
                    window.socket.on('connect', () => {
                        log('ðŸ”— [SocketIO] Connected successfully');
                        enableSocketIOMode();
                    });
                    
                    window.socket.on('connect_error', (error) => {
                        log(`âŒ [SocketIO] Connection error: ${error.message}`);
                        enableRestApiMode(`SocketIO connection failed: ${error.message}`);
                    });
                    
                    window.socket.on('disconnect', (reason) => {
                        log(`âš ï¸ [SocketIO] Disconnected: ${reason}`);
                        // Don't switch to REST API mode on disconnect, allow reconnection
                    });
                    
                } catch (error) {
                    log(`âŒ [System] Failed to initialize SocketIO: ${error.message}`);
                    enableRestApiMode(`SocketIO initialization failed: ${error.message}`);
                }
            };
            
            script.onerror = function() {
                log(`âŒ [System] Failed to load SocketIO from: ${source}`);
                currentSourceIndex++;
                tryLoadSocketIO();
            };
            
            script.src = source;
            document.head.appendChild(script);
        }
        
        // Start loading SocketIO
        tryLoadSocketIO();
        
    })();

    // Test functions
    function log(message) {
        const logDiv = document.getElementById('log');
        const timestamp = new Date().toLocaleTimeString();
        logDiv.innerHTML += `[${timestamp}] ${message}\n`;
        logDiv.scrollTop = logDiv.scrollHeight;
        console.log(message);
    }

    function updateStatus(elementId, text, className = '') {
        const element = document.getElementById(elementId);
        if (element) {
            element.textContent = text;
            element.className = className;
        }
    }

    function clearLog() {
        document.getElementById('log').innerHTML = '';
    }

    function testSocketIO() {
        log('ðŸ§ª Testing SocketIO connection...');
        
        if (window.socket) {
            if (window.socket.connected) {
                log('âœ… SocketIO is connected and working');
                updateStatus('socketio-status', 'Connected and Working', 'success');
            } else {
                log('âš ï¸ SocketIO loaded but not connected');
                updateStatus('socketio-status', 'Loaded but Disconnected', 'error');
            }
        } else {
            log('âŒ SocketIO not available');
            updateStatus('socketio-status', 'Not Available', 'error');
        }
        
        log(`ðŸ”§ REST API Mode: ${window.REST_API_MODE}`);
        log(`ðŸ”§ SocketIO Disabled: ${window.SOCKETIO_DISABLED}`);
    }

    function testAPIClient() {
        log('ðŸ§ª Testing API client initialization...');
        
        try {
            window.testAPI = new API();
            log('âœ… API client created successfully');
            updateStatus('api-status', 'Initialized', 'success');
            
            // Test if methods exist
            const methods = ['getAgentStatus', 'savePreferences', 'updatePreferences'];
            methods.forEach(method => {
                if (typeof window.testAPI[method] === 'function') {
                    log(`âœ… Method ${method} exists`);
                } else {
                    log(`âŒ Method ${method} missing`);
                }
            });
            
        } catch (error) {
            log(`âŒ Failed to create API client: ${error.message}`);
            updateStatus('api-status', 'Failed', 'error');
        }
    }

    async function testPreferencesAPI() {
        log('ðŸ§ª Testing preferences API methods...');
        
        if (!window.testAPI) {
            log('âŒ API client not initialized. Run API client test first.');
            return;
        }
        
        try {
            // Test savePreferences method
            log('ðŸ”„ Testing savePreferences method...');
            const testPrefs = { test: true, timestamp: Date.now() };
            
            try {
                await window.testAPI.savePreferences(testPrefs);
                log('âœ… savePreferences method works');
            } catch (error) {
                log(`âš ï¸ savePreferences failed (expected if server not running): ${error.message}`);
            }
            
            // Test updatePreferences method (alias)
            log('ðŸ”„ Testing updatePreferences method (alias)...');
            try {
                await window.testAPI.updatePreferences(testPrefs);
                log('âœ… updatePreferences method works (alias functional)');
            } catch (error) {
                log(`âš ï¸ updatePreferences failed (expected if server not running): ${error.message}`);
            }
            
            // Test getPreferences method
            log('ðŸ”„ Testing getPreferences method...');
            try {
                await window.testAPI.getPreferences();
                log('âœ… getPreferences method works');
            } catch (error) {
                log(`âš ï¸ getPreferences failed (expected if server not running): ${error.message}`);
            }
            
        } catch (error) {
            log(`âŒ Preferences API test failed: ${error.message}`);
        }
    }

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', () => {
        log('ðŸš€ Frontend fixes test page loaded');
        updateStatus('api-status', 'Ready for testing', 'info');
        
        // Listen for SocketIO events
        document.addEventListener('socketio-ready', () => {
            log('ðŸ“¡ Received socketio-ready event');
        });
        
        document.addEventListener('socketio-failed', (event) => {
            log(`ðŸ“¡ Received socketio-failed event: ${event.detail.error}`);
        });
    });
    </script>
</body>
</html>