<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Modern Synthesis Manager</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #1a1a1a;
            color: #ffffff;
        }
        
        #main-content {
            width: 100%;
            height: 80vh;
            border: 1px solid #333;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .test-controls {
            margin-bottom: 20px;
            padding: 10px;
            background: #2a2a2a;
            border-radius: 8px;
        }
        
        button {
            background: #007acc;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        
        button:hover {
            background: #005a9e;
        }
        
        .log-output {
            background: #000;
            color: #00ff00;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1>Modern Synthesis Manager Test</h1>
    
    <div class="test-controls">
        <button onclick="initializeManager()">Initialize Manager</button>
        <button onclick="testAPICall()">Test API Call</button>
        <button onclick="clearLogs()">Clear Logs</button>
    </div>
    
    <div id="main-content"></div>
    
    <div class="log-output" id="log-output">
        <div>Test logs will appear here...</div>
    </div>

    <!-- Include required dependencies -->
    <script>
        // Mock BaseManager for testing
        class BaseManager {
            constructor(options = {}) {
                this.options = options;
                this.state = {};
                this.elements = {};
                this.componentName = options.componentName || 'TestComponent';
                
                // Mock services
                this.durationFormatter = {
                    format: (ms) => `${Math.floor(ms/1000)}s`
                };
                this.cleanupService = {
                    cleanup: () => console.log('Cleanup called')
                };
                this.eventService = {
                    setupStandardListeners: () => console.log('Event listeners setup')
                };
                this.apiService = {
                    get: async (url) => {
                        console.log('API GET:', url);
                        return fetch(url).then(r => r.json());
                    }
                };
            }
            
            async apiCall(url, options = {}) {
                this.log(`API Call: ${url}`);
                try {
                    const response = await fetch(url);
                    const data = await response.json();
                    this.log(`API Response: ${JSON.stringify(data).substring(0, 100)}...`);
                    return data;
                } catch (error) {
                    this.logError(`API Error: ${error.message}`);
                    throw error;
                }
            }
            
            setState(newState) {
                this.state = { ...this.state, ...newState };
                this.log(`State updated: ${JSON.stringify(newState)}`);
            }
            
            setError(error, context) {
                this.logError(`Error in ${context}: ${error.message}`);
            }
            
            log(message, data = null) {
                const logEl = document.getElementById('log-output');
                const div = document.createElement('div');
                div.textContent = `[${new Date().toLocaleTimeString()}] ${this.componentName}: ${message}`;
                if (data) {
                    div.textContent += ` | Data: ${JSON.stringify(data)}`;
                }
                logEl.appendChild(div);
                logEl.scrollTop = logEl.scrollHeight;
            }
            
            logError(message, error = null) {
                const logEl = document.getElementById('log-output');
                const div = document.createElement('div');
                div.style.color = '#ff4444';
                div.textContent = `[${new Date().toLocaleTimeString()}] ERROR ${this.componentName}: ${message}`;
                if (error) {
                    div.textContent += ` | ${error}`;
                }
                logEl.appendChild(div);
                logEl.scrollTop = logEl.scrollHeight;
            }
            
            logWarn(message, data = null) {
                const logEl = document.getElementById('log-output');
                const div = document.createElement('div');
                div.style.color = '#ffaa00';
                div.textContent = `[${new Date().toLocaleTimeString()}] WARN ${this.componentName}: ${message}`;
                if (data) {
                    div.textContent += ` | ${JSON.stringify(data)}`;
                }
                logEl.appendChild(div);
                logEl.scrollTop = logEl.scrollHeight;
            }
            
            parseDateToMs(dateString) {
                if (!dateString) return 0;
                return Date.parse(dateString) || 0;
            }
            
            escapeHTML(str) {
                return String(str)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#39;');
            }
            
            cleanup() {
                this.log('Cleanup called');
            }
        }
        
        // Global variables
        let synthesisManager = null;
        
        // Test functions
        async function initializeManager() {
            try {
                // Load the ModernSynthesisManager script
                const script = document.createElement('script');
                script.src = '/knowledge_base_agent/static/v2/js/modernSynthesisManager.js';
                script.onload = async () => {
                    synthesisManager = new ModernSynthesisManager({
                        apiBase: 'http://localhost:5000'
                    });
                    
                    await synthesisManager.initialize();
                    console.log('Manager initialized successfully');
                };
                script.onerror = () => {
                    console.error('Failed to load ModernSynthesisManager script');
                };
                document.head.appendChild(script);
                
            } catch (error) {
                console.error('Failed to initialize manager:', error);
            }
        }
        
        async function testAPICall() {
            try {
                const response = await fetch('http://localhost:5000/api/synthesis');
                const data = await response.json();
                console.log('API Test Response:', data.length, 'documents');
                
                if (data.length > 0) {
                    const firstDoc = await fetch(`http://localhost:5000/api/synthesis/${data[0].id}`);
                    const fullDoc = await firstDoc.json();
                    console.log('First document content length:', fullDoc.synthesis_content ? fullDoc.synthesis_content.length : 0);
                }
            } catch (error) {
                console.error('API test failed:', error);
            }
        }
        
        function clearLogs() {
            document.getElementById('log-output').innerHTML = '<div>Logs cleared...</div>';
        }
    </script>
</body>
</html>